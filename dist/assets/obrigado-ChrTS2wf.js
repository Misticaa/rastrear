import"./style-CkDHoPGJ.js";import{i as d,s}from"./supabase-DKG8Teh-.js";import{C as u}from"./cpf-validator-B4PsRAE6.js";class m{constructor(){this.isConfigured=d(),this.isConfigured||console.warn("⚠️ Supabase não configurado. Usando armazenamento local como fallback.")}async createLead(e){if(!this.isConfigured)return this.createLeadFallback(e);try{const t={...e,initial_timestamp:e.initial_timestamp||new Date().toISOString()},{data:a,error:r}=await s.from("leads").insert([t]).select().single();return r?(console.error("Erro ao criar lead:",r),this.createLeadFallback(t)):(console.log("✅ Lead criado no Supabase:",a),{success:!0,data:a})}catch(t){return console.error("Erro na criação do lead:",t),this.createLeadFallback(leadWithTimestamp)}}async getLeadByCPF(e){if(!this.isConfigured)return this.getLeadByCPFFallback(e);try{const{data:t,error:a}=await s.from("leads").select("*").eq("cpf",e.replace(/[^\d]/g,"")).single();return a&&a.code!=="PGRST116"?(console.error("Erro ao buscar lead:",a),this.getLeadByCPFFallback(e)):{success:!0,data:t||null}}catch(t){return console.error("Erro na busca do lead:",t),this.getLeadByCPFFallback(e)}}async updateLeadStage(e,t){if(!this.isConfigured)return this.updateLeadStageFallback(e,t);try{const{data:a,error:r}=await s.from("leads").update({etapa_atual:t}).eq("cpf",e.replace(/[^\d]/g,"")).select().single();return r?(console.error("Erro ao atualizar etapa:",r),this.updateLeadStageFallback(e,t)):(console.log("✅ Etapa atualizada no Supabase:",a),{success:!0,data:a})}catch(a){return console.error("Erro na atualização da etapa:",a),this.updateLeadStageFallback(e,t)}}async updatePaymentStatus(e,t){if(!this.isConfigured)return this.updatePaymentStatusFallback(e,t);try{const{data:a,error:r}=await s.from("leads").update({status_pagamento:t}).eq("cpf",e.replace(/[^\d]/g,"")).select().single();return r?(console.error("Erro ao atualizar status de pagamento:",r),this.updatePaymentStatusFallback(e,t)):(console.log("✅ Status de pagamento atualizado no Supabase:",a),{success:!0,data:a})}catch(a){return console.error("Erro na atualização do status de pagamento:",a),this.updatePaymentStatusFallback(e,t)}}async updateLeadTimeline(e,t){if(!this.isConfigured)return this.updateLeadTimelineFallback(e,t);try{const{data:a,error:r}=await s.from("leads").update({timeline_data:t,updated_at:new Date().toISOString()}).eq("cpf",e.replace(/[^\d]/g,"")).select().single();return r?(console.error("Erro ao atualizar timeline:",r),this.updateLeadTimelineFallback(e,t)):(console.log("✅ Timeline atualizada no Supabase:",a),{success:!0,data:a})}catch(a){return console.error("Erro na atualização da timeline:",a),this.updateLeadTimelineFallback(e,t)}}createLeadFallback(e){try{const t=JSON.parse(localStorage.getItem("leads")||"[]"),a={...e,id:Date.now().toString(),created_at:new Date().toISOString(),updated_at:new Date().toISOString(),initial_timestamp:e.initial_timestamp||new Date().toISOString()};return t.push(a),localStorage.setItem("leads",JSON.stringify(t)),console.log("✅ Lead criado no localStorage:",a),{success:!0,data:a}}catch(t){return console.error("Erro no fallback de criação:",t),{success:!1,error:t.message}}}getLeadByCPFFallback(e){try{return{success:!0,data:JSON.parse(localStorage.getItem("leads")||"[]").find(r=>r.cpf===e.replace(/[^\d]/g,""))||null}}catch(t){return console.error("Erro no fallback de busca:",t),{success:!1,error:t.message}}}updateLeadStageFallback(e,t){try{const a=JSON.parse(localStorage.getItem("leads")||"[]"),r=a.findIndex(o=>o.cpf===e.replace(/[^\d]/g,""));return r!==-1?(a[r].etapa_atual=t,a[r].updated_at=new Date().toISOString(),localStorage.setItem("leads",JSON.stringify(a)),console.log("✅ Etapa atualizada no localStorage:",a[r]),{success:!0,data:a[r]}):{success:!1,error:"Lead não encontrado"}}catch(a){return console.error("Erro no fallback de atualização:",a),{success:!1,error:a.message}}}updatePaymentStatusFallback(e,t){try{const a=JSON.parse(localStorage.getItem("leads")||"[]"),r=a.findIndex(o=>o.cpf===e.replace(/[^\d]/g,""));return r!==-1?(a[r].status_pagamento=t,a[r].updated_at=new Date().toISOString(),localStorage.setItem("leads",JSON.stringify(a)),console.log("✅ Status de pagamento atualizado no localStorage:",a[r]),{success:!0,data:a[r]}):{success:!1,error:"Lead não encontrado"}}catch(a){return console.error("Erro no fallback de atualização de pagamento:",a),{success:!1,error:a.message}}}updateLeadTimelineFallback(e,t){try{const a=JSON.parse(localStorage.getItem("leads")||"[]"),r=a.findIndex(o=>o.cpf===e.replace(/[^\d]/g,""));return r!==-1?(a[r].timeline_data=t,a[r].updated_at=new Date().toISOString(),localStorage.setItem("leads",JSON.stringify(a)),console.log("✅ Timeline atualizada no localStorage:",a[r]),{success:!0,data:a[r]}):{success:!1,error:"Lead não encontrado"}}catch(a){return console.error("Erro no fallback de atualização de timeline:",a),{success:!1,error:a.message}}}}class c{static parseURLParams(){const e=new URLSearchParams(window.location.search),t={},a={nome:"nome_completo",name:"nome_completo",cpf:"cpf",email:"email",telefone:"telefone",phone:"telefone",endereco:"endereco",address:"endereco",valor:"valor_total",amount:"valor_total",payment:"meio_pagamento",pagamento:"meio_pagamento"};for(const[r,o]of Object.entries(a)){const n=e.get(r);n&&(t[o]=decodeURIComponent(n))}return t.order_bumps=this.extractOrderBumps(e),t.origem="vega",t.data_compra=new Date().toISOString(),t.produtos=[{nome:"Kit 12 caixas organizadoras + brinde",preco:t.valor_total||0,imagem:"/traduza-have-you-propose copy.png"}],t}static extractOrderBumps(e){const t=[];return[{id:"bump1",nome:"Pague em Até 5 Minutos e Ganhe Mais 3 Caixas Organizadoras",preco:0,imagem:"/traduza-have-you-propose copy.png",params:["bump1","bonus_caixas","extra_caixas"]},{id:"bump2",nome:"Leve Mais 8 Caixas Pela Metade do Preço",preco:39.9,imagem:"/traduza-have-you-propose copy.png",params:["bump2","caixas_extras","mais_caixas"]},{id:"bump3",nome:"Kit de 6 Potes Herméticos",preco:29.9,imagem:"/traduza-have-you-propose copy.png",params:["bump3","potes","hermeticos"]}].forEach(r=>{r.params.some(n=>{const i=e.get(n);return i&&(i==="1"||i==="true"||i==="yes")})&&t.push(r)}),t}static generateMockVegaData(e){const t=["João Silva Santos","Maria Oliveira Costa","Pedro Souza Lima","Ana Paula Ferreira","Carlos Eduardo Alves","Fernanda Santos Rocha"],a=["joao.silva@email.com","maria.costa@email.com","pedro.lima@email.com","ana.ferreira@email.com","carlos.alves@email.com","fernanda.rocha@email.com"],r=["Rua das Flores, 123 - Centro - São Paulo/SP - CEP: 01234-567","Av. Paulista, 456 - Bela Vista - São Paulo/SP - CEP: 01310-100","Rua Augusta, 789 - Consolação - São Paulo/SP - CEP: 01305-000"],o=parseInt(e.slice(-2))%t.length;return{nome_completo:t[o],cpf:e,email:a[o],telefone:`(11) 9${e.slice(-8)}`,endereco:r[o%r.length],valor_total:67.9,meio_pagamento:"PIX",origem:"vega",data_compra:new Date().toISOString(),produtos:[{nome:"Kit 12 caixas organizadoras + brinde",preco:67.9,imagem:"/traduza-have-you-propose copy.png"}],order_bumps:[{id:"bump2",nome:"Leve Mais 8 Caixas Pela Metade do Preço",preco:39.9,imagem:"/traduza-have-you-propose copy.png"}]}}static isVegaOrigin(){const e=new URLSearchParams(window.location.search);return e.get("origem")==="vega"||e.has("nome")||e.has("name")||e.has("vega")}}class p{constructor(){this.dbService=new m,this.vegaData=null,this.init()}async init(){console.log("🎉 Inicializando página de Obrigado");try{await this.processVegaData(),this.displayOrderData(),this.setupTrackingButton(),console.log("✅ Página de Obrigado inicializada com sucesso")}catch(e){console.error("❌ Erro na inicialização da página de Obrigado:",e),this.showError("Erro ao carregar dados do pedido")}}async processVegaData(){if(c.isVegaOrigin())console.log("📦 Processando dados do Vega Checkout"),this.vegaData=c.parseURLParams();else{const t=new URLSearchParams(window.location.search).get("cpf");if(t){console.log("🔍 Buscando dados existentes para CPF:",t);const a=await this.dbService.getLeadByCPF(t);a.success&&a.data?this.vegaData=a.data:this.vegaData=c.generateMockVegaData(t)}else this.vegaData=c.generateMockVegaData("12345678901")}this.vegaData&&await this.saveLeadData()}async saveLeadData(){try{const e=await this.dbService.getLeadByCPF(this.vegaData.cpf);if(e.success&&e.data)console.log("📝 Lead já existe, atualizando dados");else{console.log("📝 Criando novo lead no banco de dados");const t=await this.dbService.createLead(this.vegaData);t.success?console.log("✅ Lead salvo com sucesso"):console.warn("⚠️ Erro ao salvar lead:",t.error)}}catch(e){console.error("❌ Erro ao salvar dados do lead:",e)}}displayOrderData(){if(!this.vegaData){this.showError("Dados do pedido não encontrados");return}this.updateElement("customerName",this.vegaData.nome_completo),this.updateElement("customerCPF",u.formatCPF(this.vegaData.cpf)),this.updateElement("customerEmail",this.vegaData.email||"Não informado"),this.updateElement("customerPhone",this.vegaData.telefone||"Não informado"),this.updateElement("customerAddress",this.vegaData.endereco||"Não informado"),this.updateElement("totalValue",this.formatCurrency(this.vegaData.valor_total)),this.updateElement("paymentMethod",this.vegaData.meio_pagamento||"PIX"),this.updateElement("purchaseDate",this.formatDate(this.vegaData.data_compra)),this.displayProducts()}displayProducts(){const e=document.getElementById("productsList");if(!e)return;e.innerHTML="";const t={nome:"Kit 12 caixas organizadoras + brinde",preco:this.vegaData.valor_total||67.9,imagem:"/traduza-have-you-propose copy.png"};e.appendChild(this.createProductElement(t,!0)),this.vegaData.order_bumps&&this.vegaData.order_bumps.length>0&&this.vegaData.order_bumps.forEach(a=>{e.appendChild(this.createProductElement(a,!1))})}createProductElement(e,t=!1){const a=document.createElement("div");return a.className=`product-item ${t?"main-product":"order-bump"}`,a.innerHTML=`
            <div class="product-image">
                <img src="${e.imagem}" alt="${e.nome}" onerror="this.src='/traduza-have-you-propose copy.png'">
            </div>
            <div class="product-details">
                <h4 class="product-name">${e.nome}</h4>
                <div class="product-price">${this.formatCurrency(e.preco)}</div>
                ${t?'<span class="main-badge">Produto Principal</span>':'<span class="bump-badge">Order Bump</span>'}
            </div>
        `,a}setupTrackingButton(){const e=document.getElementById("trackOrderButton");e&&e.addEventListener("click",()=>{if(this.vegaData&&this.vegaData.cpf){const a=`/rastreamento.html?origem=vega&cpf=${this.vegaData.cpf.replace(/[^\d]/g,"")}`;window.location.href=a}else window.location.href="/rastreamento.html"})}updateElement(e,t){const a=document.getElementById(e);a&&(a.textContent=t)}formatCurrency(e){return e?new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(parseFloat(e)):"R$ 0,00"}formatDate(e){return e?new Date(e).toLocaleDateString("pt-BR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}):"Data não informada"}showError(e){console.error("❌ Erro:",e),this.updateElement("customerName","Cliente Shopee"),this.updateElement("customerCPF","000.000.000-00"),this.updateElement("customerEmail","cliente@email.com"),this.updateElement("customerPhone","(11) 99999-9999"),this.updateElement("customerAddress","Endereço não informado"),this.updateElement("totalValue","R$ 67,90"),this.updateElement("paymentMethod","PIX"),this.updateElement("purchaseDate",new Date().toLocaleDateString("pt-BR"))}}document.addEventListener("DOMContentLoaded",()=>{new p});
